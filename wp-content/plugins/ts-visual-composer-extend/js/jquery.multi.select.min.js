!function(t){"use strict";var e=function(e,i){this.options=i,this.$element=t(e),this.$container=t("<div/>",{"class":"ms-container"}),this.$selectableContainer=t("<div/>",{"class":"ms-selectable"}),this.$selectionContainer=t("<div/>",{"class":"ms-selection"}),this.$selectableUl=t("<ul/>",{"class":"ms-list",tabindex:"-1"}),this.$selectionUl=t("<ul/>",{"class":"ms-list",tabindex:"-1"}),this.scrollTo=0,this.elemsSelector="li:visible:not(.ms-optgroup-label,.ms-optgroup-container,."+i.disabledClass+")"};e.prototype={constructor:e,init:function(){var e=this,i=this.$element;if(0===i.next(".ms-container").length){i.css({position:"absolute",left:"-9999px"}),i.attr("id",i.attr("id")?i.attr("id"):Math.ceil(1e3*Math.random())+"multiselect"),this.$container.attr("id","ms-"+i.attr("id")),this.$container.addClass(e.options.cssClass),i.find("option").each(function(){e.generateLisFromOption(this)}),this.$selectionUl.find(".ms-optgroup-label").hide(),e.options.selectableHeader&&e.$selectableContainer.append(e.options.selectableHeader),e.$selectableContainer.append(e.$selectableUl),e.options.selectableFooter&&e.$selectableContainer.append(e.options.selectableFooter),e.options.selectionHeader&&e.$selectionContainer.append(e.options.selectionHeader),e.$selectionContainer.append(e.$selectionUl),e.options.selectionFooter&&e.$selectionContainer.append(e.options.selectionFooter),e.$container.append(e.$selectableContainer),e.$container.append(e.$selectionContainer),i.after(e.$container),e.activeMouse(e.$selectableUl),e.activeKeyboard(e.$selectableUl);var a=e.options.dblClick?"dblclick":"click";e.$selectableUl.on(a,".ms-elem-selectable",function(){e.select(t(this).data("ms-value"))}),e.$selectionUl.on(a,".ms-elem-selection",function(){e.deselect(t(this).data("ms-value"))}),e.activeMouse(e.$selectionUl),e.activeKeyboard(e.$selectionUl),i.on("focus",function(){e.$selectableUl.focus()})}var r=i.find("option:selected").map(function(){return t(this).val()}).get();e.select(r,"init"),"function"==typeof e.options.afterInit&&e.options.afterInit.call(this,this.$container)},generateLisFromOption:function(e,i){for(var a=this,r=a.$element,s="",n=t(e),o=0;o<e.attributes.length;o++){var u=e.attributes[o];"value"!==u.name&&"disabled"!==u.name&&(s+=u.name+'="'+u.value+'" ')}var h=t("<li "+s+"><span>"+a.escapeHTML(n.text())+"</span></li>"),c=h.clone(),d=n.val(),l=a.sanitize(d);h.data("ms-value",d).addClass("ms-elem-selectable").attr("id",l+"-selectable"),c.data("ms-value",d).addClass("ms-elem-selection").attr("id",l+"-selection").hide(),(n.prop("disabled")||r.prop("disabled"))&&(c.addClass(a.options.disabledClass),h.addClass(a.options.disabledClass));var f=n.parent("optgroup");if(f.length>0){var p=f.attr("label"),g=a.sanitize(p),y=a.$selectableUl.find("#optgroup-selectable-"+g),m=a.$selectionUl.find("#optgroup-selection-"+g);if(0===y.length){var v='<li class="ms-optgroup-container"></li>',j='<ul class="ms-optgroup"><li class="ms-optgroup-label"><span>'+p+"</span></li></ul>";y=t(v),m=t(v),y.attr("id","optgroup-selectable-"+g),m.attr("id","optgroup-selection-"+g),y.append(t(j)),m.append(t(j)),a.options.selectableOptgroup&&(y.find(".ms-optgroup-label").on("click",function(){var e=f.children(":not(:selected)").map(function(){return t(this).val()}).get();a.select(e)}),m.find(".ms-optgroup-label").on("click",function(){var e=f.children(":selected").map(function(){return t(this).val()}).get();a.deselect(e)})),a.$selectableUl.append(y),a.$selectionUl.append(m)}i=void 0==i?y.children().length:i+1,h.insertAt(i,y.children()),c.insertAt(i,m.children())}else i=void 0==i?a.$selectableUl.children().length:i,h.insertAt(i,a.$selectableUl),c.insertAt(i,a.$selectionUl)},addOption:function(e){var i=this;e.value&&(e=[e]),t.each(e,function(e,a){if(a.value&&0===i.$element.find("option[value='"+a.value+"']").length){var r=t('<option value="'+a.value+'">'+a.text+"</option>"),e=parseInt("undefined"==typeof a.index?i.$element.children().length:a.index),s=void 0==a.nested?i.$element:t("optgroup[label='"+a.nested+"']");r.insertAt(e,s),i.generateLisFromOption(r.get(0),e,a.nested)}})},escapeHTML:function(e){return t("<div>").text(e).html()},activeKeyboard:function(e){var i=this;e.on("focus",function(){t(this).addClass("ms-focus")}).on("blur",function(){t(this).removeClass("ms-focus")}).on("keydown",function(a){switch(a.which){case 40:case 38:return a.preventDefault(),a.stopPropagation(),i.moveHighlight(t(this),38===a.which?-1:1),void 0;case 37:case 39:return a.preventDefault(),a.stopPropagation(),i.switchList(e),void 0;case 9:if(i.$element.is("[tabindex]")){a.preventDefault();var r=parseInt(i.$element.attr("tabindex"),10);return r=a.shiftKey?r-1:r+1,t('[tabindex="'+r+'"]').focus(),void 0}a.shiftKey&&i.$element.trigger("focus")}return t.inArray(a.which,i.options.keySelect)>-1?(a.preventDefault(),a.stopPropagation(),i.selectHighlighted(e),void 0):void 0})},moveHighlight:function(t,e){var i=t.find(this.elemsSelector),a=i.filter(".ms-hover"),r=null,s=i.first().outerHeight(),n=t.height();if("#"+this.$container.prop("id"),i.off("mouseenter"),i.removeClass("ms-hover"),1===e){if(r=a.nextAll(this.elemsSelector).first(),0===r.length){var o=a.parent();if(o.hasClass("ms-optgroup")){var u=o.parent(),h=u.next(":visible");r=h.length>0?h.find(this.elemsSelector).first():i.first()}else r=i.first()}}else if(-1===e&&(r=a.prevAll(this.elemsSelector).first(),0===r.length)){var o=a.parent();if(o.hasClass("ms-optgroup")){var u=o.parent(),c=u.prev(":visible");r=c.length>0?c.find(this.elemsSelector).last():i.last()}else r=i.last()}if(r.length>0){r.addClass("ms-hover");var d=t.scrollTop()+r.position().top-n/2+s/2;t.scrollTop(d)}},selectHighlighted:function(t){var e=t.find(this.elemsSelector),i=e.filter(".ms-hover").first();i.length>0&&(t.parent().hasClass("ms-selectable")?this.select(i.data("ms-value")):this.deselect(i.data("ms-value")),e.removeClass("ms-hover"))},switchList:function(t){t.blur(),t.parent().hasClass("ms-selectable")?this.$selectionUl.focus():this.$selectableUl.focus()},activeMouse:function(e){var i=this,a=!1;e.on("mousemove",function(){if(a!==this){a=this;var r=e.find(i.elemsSelector);r.on("mouseenter",function(){r.removeClass("ms-hover"),t(this).addClass("ms-hover")})}})},refresh:function(){this.destroy(),this.$element.multiSelect(this.options)},destroy:function(){t("#ms-"+this.$element.attr("id")).remove(),this.$element.css("position","").css("left",""),this.$element.removeData("multiselect")},select:function(e,i){"string"==typeof e&&(e=[e]);var a=this,r=this.$element,s=t.map(e,function(t){return a.sanitize(t)}),n=this.$selectableUl.find("#"+s.join("-selectable, #")+"-selectable").filter(":not(."+a.options.disabledClass+")"),o=this.$selectionUl.find("#"+s.join("-selection, #")+"-selection").filter(":not(."+a.options.disabledClass+")"),u=r.find("option:not(:disabled)").filter(function(){return t.inArray(this.value,e)>-1});if("init"===i&&(n=this.$selectableUl.find("#"+s.join("-selectable, #")+"-selectable"),o=this.$selectionUl.find("#"+s.join("-selection, #")+"-selection")),n.length>0){n.addClass("ms-selected").hide(),o.addClass("ms-selected").show(),u.prop("selected",!0);var h=a.$selectableUl.children(".ms-optgroup-container");if(h.length>0){h.each(function(){var e=t(this).find(".ms-elem-selectable");e.length===e.filter(".ms-selected").length&&t(this).find(".ms-optgroup-label").hide()});var c=a.$selectionUl.children(".ms-optgroup-container");c.each(function(){var e=t(this).find(".ms-elem-selection");e.filter(".ms-selected").length>0&&t(this).find(".ms-optgroup-label").show()})}else if(a.options.keepOrder&&"init"!==i){var d=a.$selectionUl.find(".ms-selected");d.length>1&&d.last().get(0)!=o.get(0)&&o.insertAfter(d.last())}"init"!==i&&(r.trigger("change"),"function"==typeof a.options.afterSelect&&a.options.afterSelect.call(this,e))}},deselect:function(e){"string"==typeof e&&(e=[e]);var i=this,a=this.$element,r=t.map(e,function(t){return i.sanitize(t)}),s=this.$selectableUl.find("#"+r.join("-selectable, #")+"-selectable"),n=this.$selectionUl.find("#"+r.join("-selection, #")+"-selection").filter(".ms-selected").filter(":not(."+i.options.disabledClass+")"),o=a.find("option").filter(function(){return t.inArray(this.value,e)>-1});if(n.length>0){s.removeClass("ms-selected").show(),n.removeClass("ms-selected").hide(),o.prop("selected",!1);var u=i.$selectableUl.children(".ms-optgroup-container");if(u.length>0){u.each(function(){var e=t(this).find(".ms-elem-selectable");e.filter(":not(.ms-selected)").length>0&&t(this).find(".ms-optgroup-label").show()});var h=i.$selectionUl.children(".ms-optgroup-container");h.each(function(){var e=t(this).find(".ms-elem-selection");0===e.filter(".ms-selected").length&&t(this).find(".ms-optgroup-label").hide()})}a.trigger("change"),"function"==typeof i.options.afterDeselect&&i.options.afterDeselect.call(this,e)}},select_all:function(){var e=this.$element,i=e.val();if(e.find('option:not(":disabled")').prop("selected",!0),this.$selectableUl.find(".ms-elem-selectable").filter(":not(."+this.options.disabledClass+")").addClass("ms-selected").hide(),this.$selectionUl.find(".ms-optgroup-label").show(),this.$selectableUl.find(".ms-optgroup-label").hide(),this.$selectionUl.find(".ms-elem-selection").filter(":not(."+this.options.disabledClass+")").addClass("ms-selected").show(),this.$selectionUl.focus(),e.trigger("change"),"function"==typeof this.options.afterSelect){var a=t.grep(e.val(),function(e){return t.inArray(e,i)<0});this.options.afterSelect.call(this,a)}},deselect_all:function(){var t=this.$element,e=t.val();t.find("option").prop("selected",!1),this.$selectableUl.find(".ms-elem-selectable").removeClass("ms-selected").show(),this.$selectionUl.find(".ms-optgroup-label").hide(),this.$selectableUl.find(".ms-optgroup-label").show(),this.$selectionUl.find(".ms-elem-selection").removeClass("ms-selected").hide(),this.$selectableUl.focus(),t.trigger("change"),"function"==typeof this.options.afterDeselect&&this.options.afterDeselect.call(this,e)},sanitize:function(t){var e,i,a=0;if(0==t.length)return a;var r=0;for(e=0,r=t.length;r>e;e++)i=t.charCodeAt(e),a=(a<<5)-a+i,a|=0;return a}},t.fn.multiSelect=function(){var i=arguments[0],a=arguments;return this.each(function(){var r=t(this),s=r.data("multiselect"),n=t.extend({},t.fn.multiSelect.defaults,r.data(),"object"==typeof i&&i);s||r.data("multiselect",s=new e(this,n)),"string"==typeof i?s[i](a[1]):s.init()})},t.fn.multiSelect.defaults={keySelect:[32],selectableOptgroup:!1,disabledClass:"disabled",dblClick:!1,keepOrder:!1,cssClass:""},t.fn.multiSelect.Constructor=e,t.fn.insertAt=function(t,e){return this.each(function(){0===t?e.prepend(this):e.children().eq(t-1).after(this)})}}(window.jQuery);